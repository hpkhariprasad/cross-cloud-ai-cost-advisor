@page "/dashboard"
@using CostAdvisor.Shared.Models
@inject HttpClient Http

<PageTitle>Dashboard</PageTitle>

<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-6">
    <Card>
        <CardContent>
            <h2 class="text-lg font-bold">Total Cost</h2>
            <p class="text-2xl">@dashboard?.TotalCost.ToString("C")</p>
        </CardContent>
    </Card>
    <Card>
        <CardContent>
            <h2 class="text-lg font-bold">Resources</h2>
            <p class="text-2xl">@dashboard?.ResourceCount</p>
        </CardContent>
    </Card>
    <Card>
        <CardContent>
            <h2 class="text-lg font-bold">Top Provider</h2>
            <p class="text-2xl">@dashboard?.TopProvider</p>
        </CardContent>
    </Card>
    <Card>
        <CardContent>
            <h2 class="text-lg font-bold">Top Service</h2>
            <p class="text-2xl">@dashboard?.TopService</p>
        </CardContent>
    </Card>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Provider Breakdown -->
    <Card>
        <CardContent>
            <h2 class="font-bold mb-2">Provider Breakdown</h2>
            <ResponsiveContainer width="100%" height="300">
                <PieChart>
                    <Pie Data="@providerData" DataKey="value" NameKey="name" OuterRadius="100" Fill="#8884d8" Label />
                    <Tooltip />
                </PieChart>
            </ResponsiveContainer>
        </CardContent>
    </Card>

    <!-- Monthly Trend -->
    <Card>
        <CardContent>
            <h2 class="font-bold mb-2">Monthly Trend</h2>
            <ResponsiveContainer width="100%" height="300">
                <LineChart Data="@trendData">
                    <XAxis DataKey="month" />
                    <YAxis />
                    <Tooltip />
                    <Line Type="monotone" DataKey="value" Stroke="#82ca9d" />
                </LineChart>
            </ResponsiveContainer>
        </CardContent>
    </Card>
</div>

<!-- Top Services -->
<Card class="mt-6">
    <CardContent>
        <h2 class="font-bold mb-2">Top Services</h2>
        <table class="table-auto w-full">
            <thead>
                <tr>
                    <th class="text-left">Service</th>
                    <th class="text-right">Total Cost</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var svc in dashboard?.ServiceBreakdown ?? new())
                {
                    <tr>
                        <td>@svc.Service</td>
                        <td class="text-right">@svc.TotalCost.ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>
    </CardContent>
</Card>

@code {
    DashboardSummary? dashboard;
    List<object> providerData = new();
    List<object> trendData = new();

    protected override async Task OnInitializedAsync()
    {
        var from = DateTime.UtcNow.AddDays(-30);
        var to = DateTime.UtcNow;
       var url = $"api/billing/dashboard?from={from:o}&to={to:o}";
        dashboard= await Http.GetFromJsonAsync<DashboardSummary>(url) ?? new DashboardSummary();

        if (dashboard != null)
        {
            providerData = dashboard.ProviderBreakdown
                .Select(p => new { name = p.Provider, value = p.TotalCost }).Cast<object>().ToList();

            trendData = dashboard.MonthlyTrends
                .Select(m => new { month = $"{m.Month}/{m.Year}", value = m.TotalCost }).Cast<object>().ToList();
        }
    }
}
